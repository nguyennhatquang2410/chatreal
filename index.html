<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyChat - Group & Image</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        
        /* Header & Room Info */
        header { background: #0084ff; color: white; padding: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #room-display { font-size: 12px; opacity: 0.9; display: block; margin-top: 4px; }

        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        /* Messages */
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 18px; position: relative; font-size: 15px; }
        .received { align-self: flex-start; background: white; color: black; border-bottom-left-radius: 4px; }
        .sent { align-self: flex-end; background: #0084ff !important; color: white !important; border-bottom-right-radius: 4px; }
        
        .sender-name { font-size: 11px; margin-bottom: 4px; color: #65676b; font-weight: bold; }
        .sent .sender-name { display: none; }

        /* Image Style */
        .chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; display: block; }

        /* Input Area */
        #input-area { background: white; padding: 12px; display: flex; align-items: center; gap: 8px; border-top: 1px solid #ddd; }
        input[type="text"] { flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; outline: none; background: #f0f2f5; }
        
        .btn-icon { background: none; border: none; font-size: 20px; cursor: pointer; color: #0084ff; display: flex; align-items: center; }
        #send-btn { background: #0084ff; color: white; padding: 8px 18px; border-radius: 20px; font-weight: bold; border: none; cursor: pointer; }

        /* Login Screen */
        #login-screen { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        .login-box { width: 85%; max-width: 350px; }
        .login-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>H·ªá th·ªëng MyChat</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Nh·∫≠p th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
            <input type="text" id="username" placeholder="T√™n c·ªßa b·∫°n...">
            <input type="text" id="room-name" placeholder="T√™n nh√≥m (v√≠ d·ª•: hoc-tap, ban-be)">
            <button onclick="startChat()" style="width:100%; padding:12px; background:#0084ff; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">V√†o Ph√≤ng</button>
        </div>
    </div>

    <header>
        <span id="header-title">ƒêANG T·∫¢I...</span>
        <span id="room-display">ƒêang k·∫øt n·ªëi...</span>
    </header>
    
    <div id="chat-container"></div>

    <div id="input-area">
        <label class="btn-icon">
            üì∑
            <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="sendImage(this)">
        </label>
        
        <input type="text" id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button id="send-btn" onclick="sendMessage()">G·ª≠i</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDJq_ZXjQ-2Xc8yJQrtPBi6ZRvD0TLO81c",
            authDomain: "mychat-8fe77.firebaseapp.com",
            databaseURL: "https://mychat-8fe77-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mychat-8fe77",
            storageBucket: "mychat-8fe77.firebasestorage.app",
            messagingSenderId: "875406390364",
            appId: "1:875406390364:web:7e34476c57b6615a5aa299"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentUser = localStorage.getItem("chat_username") || "";
        let currentRoom = new URLSearchParams(window.location.search).get('room') || "";

        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p v√† ph√≤ng
        if (currentUser && currentRoom) {
            initChat();
        }

        function startChat() {
            const name = document.getElementById('username').value.trim();
            const room = document.getElementById('room-name').value.trim() || "chung";
            
            if (name) {
                localStorage.setItem("chat_username", name);
                // Chuy·ªÉn h∆∞·ªõng sang URL c√≥ ch·ª©a t√™n ph√≤ng
                window.location.href = `?room=${encodeURIComponent(room)}`;
            }
        }

        function initChat() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('header-title').innerText = "PH√íNG CHAT";
            document.getElementById('room-display').innerText = `Nh√≥m: ${currentRoom}`;
            
            // L·∫Øng nghe tin nh·∫Øn trong ph√≤ng c·ª• th·ªÉ
            const chatRef = db.ref("rooms/" + currentRoom);
            chatRef.limitToLast(50).on("child_added", (snapshot) => {
                displayMessage(snapshot.val());
            });
        }

        // G·ª≠i tin nh·∫Øn ch·ªØ
        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (text && currentUser && currentRoom) {
                db.ref("rooms/" + currentRoom).push({
                    sender: currentUser,
                    text: text.replace(/</g, "&lt;"),
                    type: "text",
                    timestamp: Date.now()
                });
                input.value = "";
            }
        }

        // G·ª≠i h√¨nh ·∫£nh
        function sendImage(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    db.ref("rooms/" + currentRoom).push({
                        sender: currentUser,
                        image: base64Image,
                        type: "image",
                        timestamp: Date.now()
                    });
                };
                reader.readAsDataURL(file); // Chuy·ªÉn ·∫£nh sang chu·ªói vƒÉn b·∫£n
            }
        }

        function displayMessage(data) {
            const container = document.getElementById('chat-container');
            const isMe = data.sender === currentUser;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${isMe ? 'sent' : 'received'}`;
            
            let content = "";
            if (data.type === "image") {
                content = `<img src="${data.image}" class="chat-img" onclick="window.open(this.src)">`;
            } else {
                content = `<div class="text">${data.text}</div>`;
            }

            msgDiv.innerHTML = `
                ${!isMe ? `<div class="sender-name">${data.sender}</div>` : ''}
                ${content}
            `;
            
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
