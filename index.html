<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyChat - Private Invite</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        /* Gi·ªØ nguy√™n c√°c Style c≈© v√† th√™m style cho tin nh·∫Øn m·ªùi */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        header { background: #0084ff; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        /* Message Rows */
        .msg-row { display: flex; align-items: flex-end; gap: 8px; max-width: 85%; position: relative; }
        .received-row { align-self: flex-start; }
        .sent-row { align-self: flex-end; flex-direction: row-reverse; }

        .avatar { width: 35px; height: 35px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; flex-shrink: 0; }
        .msg { padding: 8px 14px; border-radius: 18px; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .received { background: white; color: black; border-bottom-left-radius: 4px; }
        .sent { background: #0084ff; color: white; border-bottom-right-radius: 4px; }
        
        /* Tin nh·∫Øn m·ªùi chat ri√™ng */
        .invite-msg { align-self: center; background: #fff3cd; color: #856404; padding: 5px 15px; border-radius: 10px; font-size: 12px; border: 1px dashed #ffeeba; margin: 5px 0; cursor: pointer; }

        #input-area { background: white; padding: 10px; display: flex; gap: 10px; border-top: 1px solid #ddd; align-items: center; }
        #message-input { flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; outline: none; background: #f0f2f5; }
        .chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; padding: 20px; border-radius: 10px; width: 300px; text-align: center; }
    </style>
</head>
<body>

    <div id="login-overlay" class="overlay">
        <div class="modal">
            <h3>Nh·∫≠p t√™n ƒë·ªÉ chat</h3>
            <input type="text" id="username-input" style="width:100%; padding:10px; margin:10px 0;">
            <button onclick="saveUser()" style="width:100%; padding:10px; background:#0084ff; color:white; border:none; cursor:pointer;">V√†o Chat</button>
        </div>
    </div>

    <header>
        <div id="room-info">
            <h4 id="display-room-name">Ph√≤ng: Chung</h4>
        </div>
        <button onclick="location.href='?'" style="background:white; border:none; padding:5px; border-radius:5px; cursor:pointer;">üè† V·ªÅ S·∫£nh</button>
    </header>
    
    <div id="chat-container"></div>

    <div id="input-area">
        <label style="cursor:pointer">üì∑<input type="file" accept="image/*" style="display:none" onchange="uploadImg(this)"></label>
        <input type="text" id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendText()">
        <button onclick="sendText()" style="background:none; border:none; font-size:20px; cursor:pointer;">üöÄ</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDJq_ZXjQ-2Xc8yJQrtPBi6ZRvD0TLO81c",
            authDomain: "mychat-8fe77.firebaseapp.com",
            databaseURL: "https://mychat-8fe77-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mychat-8fe77",
            storageBucket: "mychat-8fe77.firebasestorage.app",
            messagingSenderId: "875406390364",
            appId: "1:875406390364:web:7e34476c57b6615a5aa299"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentUser = localStorage.getItem("chat_username") || "";
        let currentRoom = new URLSearchParams(window.location.search).get('r') || "Chung";

        if (currentUser) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('display-room-name').innerText = "Ph√≤ng: " + currentRoom;
            startListening();
        }

        function saveUser() {
            const name = document.getElementById('username-input').value.trim();
            if (name) {
                localStorage.setItem("chat_username", name);
                location.reload();
            }
        }

        // CH·ª®C NƒÇNG QUAN TR·ªåNG: M·ªúI CHAT RI√äNG
        function invitePrivate(targetUser) {
            if (targetUser === currentUser) return;
            const roomID = [currentUser, targetUser].sort().join("_vs_");
            const privateLink = `?r=${encodeURIComponent(roomID)}`;
            
            // 1. G·ª≠i tin nh·∫Øn m·ªùi v√†o ph√≤ng CHUNG ƒë·ªÉ b·∫°n c·ªßa b·∫°n th·∫•y
            db.ref("rooms/Chung").push({
                sender: "H·ªÜ TH·ªêNG",
                content: `${currentUser} m·ªùi ${targetUser} v√†o ph√≤ng ri√™ng. <a href="${privateLink}">NH·∫§N V√ÄO ƒê√ÇY ƒê·ªÇ V√ÄO</a>`,
                type: 'invite',
                to: targetUser // Ghi ch√∫ ng∆∞·ªùi ƒë∆∞·ª£c m·ªùi
            });

            // 2. T·ª± ƒë·ªông chuy·ªÉn m√¨nh v√†o ph√≤ng ƒë√≥ lu√¥n
            location.href = privateLink;
        }

        function startListening() {
            db.ref("rooms/" + currentRoom).limitToLast(50).on("child_added", (snap) => {
                const data = snap.val();
                const container = document.getElementById('chat-container');
                
                // N·∫øu l√† tin nh·∫Øn m·ªùi
                if (data.type === 'invite') {
                    const inviteDiv = document.createElement('div');
                    inviteDiv.className = 'invite-msg';
                    inviteDiv.innerHTML = data.content;
                    container.appendChild(inviteDiv);
                } else {
                    const isMe = data.sender === currentUser;
                    const row = document.createElement('div');
                    row.className = `msg-row ${isMe ? 'sent-row' : 'received-row'}`;
                    
                    const avatar = `<div class="avatar" onclick="invitePrivate('${data.sender}')" style="background:${stringToColor(data.sender)}">${data.sender.charAt(0).toUpperCase()}</div>`;
                    
                    let body = data.type === 'img' 
                        ? `<img src="${data.content}" class="chat-img" onclick="window.open(this.src)">` 
                        : `<div class="msg ${isMe ? 'sent' : 'received'}">${data.content}</div>`;

                    row.innerHTML = `${avatar}<div style="display:flex; flex-direction:column"><small style="font-size:10px; margin:0 5px">${data.sender}</small>${body}</div>`;
                    container.appendChild(row);
                }
                container.scrollTop = container.scrollHeight;
            });
        }

        function sendText() {
            const input = document.getElementById('message-input');
            if (input.value.trim()) {
                db.ref("rooms/" + currentRoom).push({
                    sender: currentUser,
                    content: input.value.trim().replace(/</g, "&lt;"),
                    type: 'text',
                    timestamp: Date.now()
                });
                input.value = "";
            }
        }

        function uploadImg(el) {
            const file = el.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    db.ref("rooms/" + currentRoom).push({ sender: currentUser, content: e.target.result, type: 'img' });
                };
                reader.readAsDataURL(file);
            }
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash) % 360}, 70%, 45%)`;
        }
    </script>
</body>
    </html>
