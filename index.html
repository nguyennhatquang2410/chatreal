<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyChat - Pro Version</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        
        header { background: #0084ff; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .room-info h4 { margin: 0; font-size: 15px; }
        .room-info span { font-size: 11px; opacity: 0.8; }

        /* Khung Chat */
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Tin nh·∫Øn v√† Avatar */
        .msg-row { display: flex; align-items: flex-end; gap: 8px; max-width: 85%; }
        .received-row { align-self: flex-start; }
        .sent-row { align-self: flex-end; flex-direction: row-reverse; }

        .avatar { width: 35px; height: 35px; border-radius: 50%; background: #0084ff; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; cursor: pointer; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .avatar:hover::after { content: 'Nh·∫Øn tin ri√™ng'; position: absolute; background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-top: -45px; white-space: nowrap; }

        .msg-content { display: flex; flex-direction: column; }
        .msg { padding: 10px 14px; border-radius: 18px; font-size: 15px; word-wrap: break-word; }
        .received { background: white; color: black; border-bottom-left-radius: 4px; }
        .sent { background: #0084ff; color: white; border-bottom-right-radius: 4px; }
        
        .sender-name { font-size: 11px; margin-bottom: 4px; color: #65676b; font-weight: 600; margin-left: 5px; }
        .sent-row .sender-name { text-align: right; margin-right: 5px; }

        .chat-img { max-width: 100%; border-radius: 12px; margin-top: 5px; display: block; border: 1px solid #ddd; }

        /* Input Area */
        #input-area { background: white; padding: 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; }
        #message-input { flex: 1; padding: 12px 18px; border: 1px solid #ddd; border-radius: 25px; outline: none; background: #f0f2f5; }
        .icon-btn { cursor: pointer; font-size: 22px; color: #0084ff; transition: transform 0.2s; }
        .icon-btn:hover { transform: scale(1.1); }

        /* Modals */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 320px; text-align: center; }
        .modal input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }
        .modal button { width: 100%; padding: 12px; background: #0084ff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        /* N√∫t b·∫≠t th√¥ng b√°o */
        #noti-btn { background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="login-overlay" class="overlay">
        <div class="modal">
            <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi MyChat</h3>
            <input type="text" id="username-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
            <button onclick="saveUser()">B·∫Øt ƒë·∫ßu ngay</button>
        </div>
    </div>

    <header>
        <div class="room-info">
            <h4 id="display-room-name">Ph√≤ng: Chung</h4>
            <span id="display-username">ƒêang t·∫£i...</span>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
            <button id="noti-btn" onclick="requestPermission()">üîî B·∫≠t th√¥ng b√°o</button>
            <button class="btn-room" style="background: rgba(255,255,255,0.2); border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;" onclick="location.href='?'">üè† Chung</button>
            <button class="btn-room" style="background: rgba(255,255,255,0.2); border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;" onclick="openRoomModal()">‚ûï Ph√≤ng</button>
        </div>
    </header>
    
    <div id="chat-container"></div>

    <div id="input-area">
        <label class="icon-btn">üñºÔ∏è<input type="file" accept="image/*" style="display:none" onchange="uploadImg(this)"></label>
        <input type="text" id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendText()">
        <div class="icon-btn" onclick="sendText()">üöÄ</div>
    </div>

    <audio id="noti-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <div id="room-overlay" class="overlay" style="display: none;">
        <div class="modal">
            <h3>V√†o ph√≤ng m·ªõi</h3>
            <input type="text" id="room-input" placeholder="T√™n ph√≤ng...">
            <button onclick="changeRoom()">Tham gia</button>
            <button onclick="document.getElementById('room-overlay').style.display='none'" style="background:#ccc; margin-top:5px;">H·ªßy</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDJq_ZXjQ-2Xc8yJQrtPBi6ZRvD0TLO81c",
            authDomain: "mychat-8fe77.firebaseapp.com",
            databaseURL: "https://mychat-8fe77-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mychat-8fe77",
            storageBucket: "mychat-8fe77.firebasestorage.app",
            messagingSenderId: "875406390364",
            appId: "1:875406390364:web:7e34476c57b6615a5aa299"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentUser = localStorage.getItem("chat_username") || "";
        let currentRoom = new URLSearchParams(window.location.search).get('r') || "Chung";

        window.onload = () => {
            if (!currentUser) {
                document.getElementById('login-overlay').style.display = 'flex';
            } else {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('display-username').innerText = "B·∫°n: " + currentUser;
                document.getElementById('display-room-name').innerText = "üìç " + currentRoom;
                
                // ·∫®n n√∫t th√¥ng b√°o n·∫øu ƒë√£ c·∫•p quy·ªÅn
                if (Notification.permission === "granted") {
                    document.getElementById('noti-btn').style.display = 'none';
                }
                
                startListening();
            }
        };

        // H√†m y√™u c·∫ßu quy·ªÅn th√¥ng b√°o
        function requestPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    document.getElementById('noti-btn').style.display = 'none';
                    alert("ƒê√£ b·∫≠t th√¥ng b√°o!");
                }
            });
        }

        function saveUser() {
            const name = document.getElementById('username-input').value.trim();
            if (name) {
                localStorage.setItem("chat_username", name);
                location.reload();
            }
        }

        function openRoomModal() { document.getElementById('room-overlay').style.display = 'flex'; }
        
        function changeRoom() {
            const room = document.getElementById('room-input').value.trim();
            if(room) window.location.href = `?r=${encodeURIComponent(room)}`;
        }

        function startPrivateChat(otherUser) {
            if (otherUser === currentUser) return;
            const roomID = [currentUser, otherUser].sort().join("_VS_");
            window.location.href = `?r=üîí_${encodeURIComponent(roomID)}`;
        }

        function startListening() {
            const chatRef = db.ref("rooms/" + currentRoom);
            let initialLoad = true;

            // ƒê√°nh d·∫•u ƒë√£ load xong d·ªØ li·ªáu c≈© sau 2 gi√¢y
            setTimeout(() => { initialLoad = false; }, 2000);

            chatRef.limitToLast(50).on("child_added", (snap) => {
                const data = snap.val();
                const isMe = data.sender === currentUser;
                
                displayMessage(data, isMe);

                // TH√îNG B√ÅO: Ch·ªâ ch·∫°y khi kh√¥ng ph·∫£i m√¨nh nh·∫Øn v√† ƒë√£ load xong d·ªØ li·ªáu c≈©
                if (!isMe && !initialLoad) {
                    // Ph√°t √¢m thanh
                    document.getElementById('noti-sound').play().catch(() => {});

                    // Th√¥ng b√°o ƒë·∫©y (n·∫øu ƒëang ·ªü tab kh√°c)
                    if (Notification.permission === "granted" && document.hidden) {
                        new Notification(`Tin nh·∫Øn t·ª´ ${data.sender}`, {
                            body: data.type === 'img' ? '[H√¨nh ·∫£nh]' : data.content,
                            icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png'
                        });
                    }
                }
            });
        }

        function displayMessage(data, isMe) {
            const container = document.getElementById('chat-container');
            const row = document.createElement('div');
            row.className = `msg-row ${isMe ? 'sent-row' : 'received-row'}`;
            
            const initial = data.sender.charAt(0).toUpperCase();
            const avatar = `<div class="avatar" onclick="startPrivateChat('${data.sender}')" style="background:${stringToColor(data.sender)}">${initial}</div>`;
            
            let body = data.type === 'img' 
                ? `<img src="${data.content}" class="chat-img" onclick="window.open(this.src)">` 
                : `<div class="msg ${isMe ? 'sent' : 'received'}">${data.content}</div>`;

            row.innerHTML = `
                ${avatar}
                <div class="msg-content">
                    <div class="sender-name">${data.sender}</div>
                    ${body}
                </div>
            `;
            
            container.appendChild(row);
            container.scrollTop = container.scrollHeight;
        }

        function sendText() {
            const input = document.getElementById('message-input');
            if (input.value.trim()) {
                db.ref("rooms/" + currentRoom).push({
                    sender: currentUser,
                    content: input.value.trim().replace(/</g, "&lt;"),
                    type: 'text',
                    timestamp: Date.now()
                });
                input.value = "";
            }
        }

        function uploadImg(el) {
            const file = el.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    db.ref("rooms/" + currentRoom).push({
                        sender: currentUser,
                        content: e.target.result,
                        type: 'img',
                        timestamp: Date.now()
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return `hsl(${Math.abs(hash) % 360}, 65%, 45%)`;
        }
    </script>
</body>
</html>
